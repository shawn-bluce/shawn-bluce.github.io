<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™ - Shawn's blog</title><meta name=Description content="åˆ†äº«æˆ‘çš„çŸ¥è¯†ã€ç»éªŒã€ç”Ÿæ´»ä¸æ„Ÿæ‚Ÿ"><meta property="og:url" content="https://blog.programmer.work/posts/django-permission/"><meta property="og:site_name" content="Shawn's blog"><meta property="og:title" content="å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™"><meta property="og:description" content="0X00 Django ä¸­çš„æƒé™ç»“æ„ã€å®šä¹‰ æˆ‘ä»¬çŸ¥é“åœ¨åˆ›å»ºäº†ä¸€ä¸ª Django é¡¹ç›®ä¹‹åï¼Œé»˜è®¤å°±æœ‰ä¸¤ä¸ªå…¬å¼€å¯ç”¨çš„ modelï¼šUser å’Œ Groupï¼Œè¿™ä¸¤ä¸ª model çš„ä¸€é¡¹åŠŸèƒ½å°±æ˜¯ç”¨æ¥åšæƒé™ç®¡ç†çš„ã€‚ç³»ç»Ÿä¸­ä¼šæœ‰å¾ˆå¤šé¡¹æƒé™ï¼Œå•ä¸ª user å¯ä»¥é…ç½®æ‹¥æœ‰å“ªäº›æƒé™ï¼Œä¹Ÿå¯ä»¥å°†æƒé™é…ç½®ç»™ groupã€‚ç„¶åæ ¡éªŒå•ä¸ªæƒé™çš„æ—¶å€™å…¶å®å°±æ˜¯å°† user æœ¬èº«çš„æƒé™ï¼Œå’Œ user æ‰€åœ¨çš„æ‰€æœ‰ç»„çš„æƒé™åšä¸€ä¸ªå¹¶é›†ï¼Œçœ‹æœ¬æ¬¡æ“ä½œçš„æƒé™æ˜¯å¦åœ¨è¿™ä¸ªå¹¶é›†é‡Œã€‚åœ¨ï¼Œé‚£å°±æ ¡éªŒé€šè¿‡ï¼›ä¸åœ¨ï¼Œé‚£å°±åªæœ‰ HTTP 403 äº†ã€‚"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-05T05:24:00+00:00"><meta property="article:modified_time" content="2025-01-16T08:46:40+00:00"><meta property="article:tag" content="Django"><meta property="article:tag" content="DRF"><meta property="article:tag" content="Permission"><meta property="og:image" content="https://blog.programmer.work/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.programmer.work/logo.png"><meta name=twitter:title content="å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™"><meta name=twitter:description content="0X00 Django ä¸­çš„æƒé™ç»“æ„ã€å®šä¹‰ æˆ‘ä»¬çŸ¥é“åœ¨åˆ›å»ºäº†ä¸€ä¸ª Django é¡¹ç›®ä¹‹åï¼Œé»˜è®¤å°±æœ‰ä¸¤ä¸ªå…¬å¼€å¯ç”¨çš„ modelï¼šUser å’Œ Groupï¼Œè¿™ä¸¤ä¸ª model çš„ä¸€é¡¹åŠŸèƒ½å°±æ˜¯ç”¨æ¥åšæƒé™ç®¡ç†çš„ã€‚ç³»ç»Ÿä¸­ä¼šæœ‰å¾ˆå¤šé¡¹æƒé™ï¼Œå•ä¸ª user å¯ä»¥é…ç½®æ‹¥æœ‰å“ªäº›æƒé™ï¼Œä¹Ÿå¯ä»¥å°†æƒé™é…ç½®ç»™ groupã€‚ç„¶åæ ¡éªŒå•ä¸ªæƒé™çš„æ—¶å€™å…¶å®å°±æ˜¯å°† user æœ¬èº«çš„æƒé™ï¼Œå’Œ user æ‰€åœ¨çš„æ‰€æœ‰ç»„çš„æƒé™åšä¸€ä¸ªå¹¶é›†ï¼Œçœ‹æœ¬æ¬¡æ“ä½œçš„æƒé™æ˜¯å¦åœ¨è¿™ä¸ªå¹¶é›†é‡Œã€‚åœ¨ï¼Œé‚£å°±æ ¡éªŒé€šè¿‡ï¼›ä¸åœ¨ï¼Œé‚£å°±åªæœ‰ HTTP 403 äº†ã€‚"><meta name=application-name content="Shawn's blog"><meta name=apple-mobile-web-app-title content="Shawn's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.programmer.work/posts/django-permission/><link rel=prev href=https://blog.programmer.work/posts/sso-yu-cas/><link rel=next href=https://blog.programmer.work/posts/django-save-exception/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.programmer.work\/posts\/django-permission\/"},"genre":"posts","keywords":"Django, DRF, Permission","wordcount":3866,"url":"https:\/\/blog.programmer.work\/posts\/django-permission\/","datePublished":"2020-07-05T05:24:00+00:00","dateModified":"2025-01-16T08:46:40+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Shawn"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shawn's blog">Shawn's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/about/>å…³äº </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shawn's blog">Shawn's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/about/ title>å…³äº</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.programmer.work title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Shawn</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-07-05>2020-07-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 3866 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><h1 id=0x00-django-ä¸­çš„æƒé™ç»“æ„å®šä¹‰>0X00 Django ä¸­çš„æƒé™ç»“æ„ã€å®šä¹‰</h1><p>æˆ‘ä»¬çŸ¥é“åœ¨åˆ›å»ºäº†ä¸€ä¸ª Django é¡¹ç›®ä¹‹åï¼Œé»˜è®¤å°±æœ‰ä¸¤ä¸ªå…¬å¼€å¯ç”¨çš„ modelï¼šUser å’Œ Groupï¼Œè¿™ä¸¤ä¸ª model çš„ä¸€é¡¹åŠŸèƒ½å°±æ˜¯ç”¨æ¥åšæƒé™ç®¡ç†çš„ã€‚ç³»ç»Ÿä¸­ä¼šæœ‰å¾ˆå¤šé¡¹æƒé™ï¼Œå•ä¸ª user å¯ä»¥é…ç½®æ‹¥æœ‰å“ªäº›æƒé™ï¼Œä¹Ÿå¯ä»¥å°†æƒé™é…ç½®ç»™ groupã€‚ç„¶åæ ¡éªŒå•ä¸ªæƒé™çš„æ—¶å€™å…¶å®å°±æ˜¯å°† user æœ¬èº«çš„æƒé™ï¼Œå’Œ user æ‰€åœ¨çš„æ‰€æœ‰ç»„çš„æƒé™åšä¸€ä¸ªå¹¶é›†ï¼Œçœ‹æœ¬æ¬¡æ“ä½œçš„æƒé™æ˜¯å¦åœ¨è¿™ä¸ªå¹¶é›†é‡Œã€‚åœ¨ï¼Œé‚£å°±æ ¡éªŒé€šè¿‡ï¼›ä¸åœ¨ï¼Œé‚£å°±åªæœ‰ HTTP 403 äº†ã€‚</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png data-srcset="https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png, https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png 1.5x, https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png 2x" data-sizes=auto alt=https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png title=https://blog-1251664340.cos.ap-chengdu.myqcloud.com/20200705173202.png></p><blockquote><p>HTTP 401 å’Œ HTTP 403 çš„åŒºåˆ«ï¼š401 çš„æè¿°æ˜¯ Forbiddenï¼Œè€Œ 401 æ˜¯ Unauthorizedï¼Œå‰è€…æ˜¯æ²¡æœ‰æƒé™ï¼Œè€Œåè€…å¹²è„†æ²¡é€šè¿‡è®¤è¯ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½ æƒ³æŸ¥çœ‹å…¬å¸è´¢åŠ¡çš„è¯¦ç»†æŠ¥è¡¨ï¼Œè´¢åŠ¡ç»ç†ä¸€çœ‹ä½ å°±æ˜¯ä¸ªä¸€çº¿å°ç¨‹åºå‘˜ï¼Œå°±ç»™ä½ ä¸€ä¸ª 401ï¼Œå‘Šè¯‰ä½ è¿™ä¸æ˜¯ä½ å¯ä»¥çœ‹çš„ä¸œè¥¿ã€‚å¦‚æœä½ æƒ³çœ‹åˆ«çš„å…¬å¸è´¢åŠ¡çš„è¯¦ç»†æŠ¥è¡¨ï¼Œåˆ«äººå…¬å¸è´¢åŠ¡ç»ç†ä¸€çœ‹ä½ æ ¹æœ¬ä¸æ˜¯ä»–ä»¬å…¬å¸çš„äººï¼Œå°±ç›´æ¥ç»™ä½ äº†ä¸ª 401 äº†ã€‚ï¼ˆä¿—è¯è¯´åä¸ªæ¯”å–»ä¹ä¸ªä¸å‡†ï¼Œæˆ‘è¿™ä¸ªæ¯”å–»å½“ç„¶ä¹Ÿå¹¶ä¸éå¸¸å‡†ç¡®ï¼Œä¸è¿‡å¯¹äºåˆ†ä¸æ¸… 401 å’Œ 403 çš„åŒå­¦è€Œè¨€åº”è¯¥ä¹Ÿé—®é¢˜ä¸å¤§ğŸ¤£ï¼‰</p></blockquote><p>Django è‡ªå·±å¯¹æ¯ä¸€ä¸ª model éƒ½åˆ›å»ºäº† createï¼Œupdateï¼Œdelete çš„æƒé™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ·»åŠ æ–°æƒé™ã€‚Django è‡ªå·±æ˜¯é’ˆå¯¹å„ä¸ª model åšçš„æƒé™ï¼Œæ‰€ä»¥æœ€ç®€å•çš„æƒé™å»ºç«‹æ˜¯åœ¨ model å±‚è¿›è¡Œçš„ã€‚å°±æ¯”å¦‚ä¸‹é¢è¿™ç§ï¼Œå¦‚æœæˆ‘æƒ³è¦ä¸º Student è¿™ä¸ª model å»ºç«‹ç›¸å…³çš„æƒé™ï¼Œå°±å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>Meta</code> ç±»é‡Œçš„ <code>permissions</code> æ¥å®ç°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Student</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>      	user <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>OneToOneField(<span style=color:#e6db74>&#39;django.contrib.auth.models.User&#39;</span>)
</span></span><span style=display:flex><span>      	name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField() <span style=color:#75715e># çº¯å±•ç¤ºï¼Œå°±ä¸è¯¦ç»†å®šä¹‰äº†</span>
</span></span><span style=display:flex><span>        birthday <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DatetimeField()
</span></span><span style=display:flex><span>        phone <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>    				verbose_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;å­¦ç”Ÿ&#39;</span>
</span></span><span style=display:flex><span>            verbose_name_plural <span style=color:#f92672>=</span> verbose_name
</span></span><span style=display:flex><span>            permissions <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>            		<span style=color:#75715e># (&#39;æƒé™å&#39;, &#39;æƒé™æè¿°&#39;),</span>
</span></span><span style=display:flex><span>              	(<span style=color:#e6db74>&#39;check_classmate_score&#39;</span>, <span style=color:#e6db74>&#39;æŸ¥çœ‹åŒç­åŒå­¦çš„æˆç»©&#39;</span>),
</span></span><span style=display:flex><span>              	(<span style=color:#e6db74>&#39;send_class_notify&#39;</span>, <span style=color:#e6db74>&#39;å‘é€ç­çº§é€šçŸ¥&#39;</span>),
</span></span><span style=display:flex><span>            )
</span></span></code></pre></div><p>ä¸è¿‡è¿™é‡Œä¹Ÿçœ‹åˆ°äº†ï¼Œæ¯æ¬¡å¯¹æƒé™è¿›è¡Œ CUD çš„æ—¶å€™éƒ½æ˜¯åœ¨æ”¹ model çš„ï¼Œæ‰€ä»¥æ¯æ¬¡æ”¹åŠ¨å®Œ model è®°å¾—éƒ½è¦è¿›è¡Œä¸€æ¬¡<code>migrate</code>æ“ä½œæ‰è¡Œã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒæ€§èƒ½é—®é¢˜ï¼Œè¿™ä¸ª migrate åªå¯¹ Permission è¡¨è¿›è¡Œ CUD æ“ä½œï¼Œè€Œå¹¶éæ”¹è¡¨ï¼Œæ‰€ä»¥éå¸¸å¿«å°±æå®šäº†ã€‚æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸ç®¡ä½ æŠŠè¿™äº› permissions å†™åœ¨å“ªä¸ª model ä¸‹ï¼Œæœ€ç»ˆä»–ä»¬åˆ›å»ºå¥½çš„æ•°æ®éƒ½è¿˜æ˜¯åœ¨ Permission è¡¨é‡Œï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“ï¼ˆæˆ‘è¿™é‡Œç”¨çš„æ˜¯ MySQLï¼‰é‡Œçš„<code>auth_permission</code>è¡¨äº†ï¼Œè¿™ä¸ªè¡¨ç»“æ„å’Œæ•°æ®æ˜¯ä¸‹é¢è¿™æ ·çš„ã€‚</p><pre tabindex=0><code>    +-----------------+--------------+------+-----+---------+----------------+
    | Field           | Type         | Null | Key | Default | Extra          |
    +-----------------+--------------+------+-----+---------+----------------+
    | id              | int(11)      | NO   | PRI | &lt;null&gt;  | auto_increment |
    | name            | varchar(255) | NO   |     | &lt;null&gt;  |                |
    | content_type_id | int(11)      | NO   | MUL | &lt;null&gt;  |                |
    | codename        | varchar(100) | NO   |     | &lt;null&gt;  |                |
    +-----------------+--------------+------+-----+---------+----------------+



    +-----+------------------------------------+-----------------+-------------------------------+
    | id  | name                               | content_type_id | codename                      |
    +-----+------------------------------------+-----------------+-------------------------------+
    | 1   | Can add log entry                  | 1               | add_logentry                  |
    | 2   | Can change log entry               | 1               | change_logentry               |
    | 3   | Can delete log entry               | 1               | delete_logentry               |
    | 4   | Can add group                      | 2               | add_group                     |
    | 5   | Can change group                   | 2               | change_group                  |
    | 6   | Can delete group                   | 2               | delete_group                  |
    | 7   | Can add permission                 | 3               | add_permission                |
    | 8   | Can change permission              | 3               | change_permission             |
    | 9   | Can delete permission              | 3               | delete_permission             |
    | 10  | Can add user                       | 4               | add_user                      |
    | 11  | Can change user                    | 4               | change_user                   |
    | 12  | Can delete user                    | 4               | delete_user                   |
    +-----+------------------------------------+-----------------+-------------------------------+
</code></pre><h1 id=0x01-åœ¨-django-ä¸­æ ¡éªŒä¸åˆ†é…æƒé™>0X01 åœ¨ Django ä¸­æ ¡éªŒä¸åˆ†é…æƒé™</h1><p>æƒé™åœ¨è¡¨é‡Œä¹‹åâ€œå”¯ä¸€â€ç”Ÿæ•ˆçš„åœ°æ–¹å°±æ˜¯ django-admin äº†ï¼Œå°±æ˜¯è¯´å¦‚æœç™»å½• django-admin çš„ç”¨æˆ·æ²¡æœ‰<code>add_user</code>çš„æƒé™ï¼Œé‚£ä½ åˆ›å»ºç”¨æˆ·çš„æ—¶å€™å°±ä¼šè¢«æ‹’ç»ã€‚ä½†æ˜¯æˆ‘ä»¬å¹³æ—¶æ›´å¤šçš„æ—¶å€™å¹¶ä¸æ˜¯åœ¨ django-admin é‡Œï¼Œè€Œæ˜¯è‡ªå·±å®ç°çš„å‰å°é¡µé¢ï¼Œé‚£è¯¥æ€ä¹ˆè‡ªå·±æ ¡éªŒæƒé™å‘¢ï¼ŸDjango ä¸­ç»™ user å®ä¾‹äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>user.has_perm</code>å’Œ<code>user.has_perms</code>ã€‚æ˜¾ç„¶ï¼Œå‰è€…æ ¡éªŒå•ä¸ªæƒé™ï¼Œåè€…æ ¡éªŒå¤šä¸ªæƒé™ã€‚å’±ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•æ ¡éªŒçš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    In [<span style=color:#ae81ff>1</span>]: <span style=color:#f92672>from</span> django.contrib.auth.models <span style=color:#f92672>import</span> User
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>2</span>]: shawn <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>create(username<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;shawn&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>3</span>]: shawn<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;auth.add_user&#39;</span>)	<span style=color:#75715e># å•ä¸ªæƒé™æ ¡éªŒç›´æ¥ä¼ æƒé™çš„ code_name</span>
</span></span><span style=display:flex><span>    Out[<span style=color:#ae81ff>3</span>]: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>4</span>]: shawn<span style=color:#f92672>.</span>has_perms([<span style=color:#e6db74>&#39;auth.add_user&#39;</span>, <span style=color:#e6db74>&#39;auth.del_user&#39;</span>])  <span style=color:#75715e># å¤šä¸ªå…¨çº¿åŒæ—¶æ£€éªŒæ—¶å°†å¤šä¸ª code_name æ”¾åœ¨åˆ—è¡¨ä¸­</span>
</span></span><span style=display:flex><span>    Out[<span style=color:#ae81ff>4</span>]: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>5</span>]: admin <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>create(username<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;admin&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>6</span>]: admin<span style=color:#f92672>.</span>is_superuser <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>		<span style=color:#75715e># è®¾ç½® admin ç”¨æˆ·ä¸ºè¶…çº§ç®¡ç†å‘˜</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>7</span>]: admin<span style=color:#f92672>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>8</span>]: admin<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;auth.add_user&#39;</span>)
</span></span><span style=display:flex><span>    Out[<span style=color:#ae81ff>8</span>]: <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>9</span>]: admin<span style=color:#f92672>.</span>has_perms([<span style=color:#e6db74>&#39;auth.add_user&#39;</span>, <span style=color:#e6db74>&#39;auth.del_user&#39;</span>])
</span></span><span style=display:flex><span>    Out[<span style=color:#ae81ff>9</span>]: <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ä» Django æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ­£åœ¨æ ¡éªŒçš„ç”¨æˆ·æ˜¯â€œæ´»è·ƒçš„â€è€Œä¸”æ˜¯â€œè¶…çº§ç®¡ç†å‘˜â€ï¼Œé‚£å°±ç›´æ¥ä¸æ ¡éªŒäº†ï¼Œé€šè¿‡ã€‚å¦åˆ™å°±å»æ ¡éªŒä¸€æ³¢ã€‚åŒæ—¶æ ¡éªŒå¤šä¸ªæƒé™çš„æ—¶å€™ç”¨äº†<code>all</code>å»é€ä¸ªæ ¡éªŒï¼Œé‡åˆ°ä¸€ä¸ªæ²¡æœ‰çš„æƒé™ä¹Ÿå°± False äº†ã€‚å…·ä½“çš„ç»†èŠ‚è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹æºç ï¼Œåœ¨<code>django.contrib.auth.models.User</code>ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>has_perm</span>(self, perm, obj<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Return True if the user has the specified permission. Query all
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        available auth backends, but return immediately if any backend returns
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        True. Thus, a user who has permission from a single auth backend is
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        assumed to have permission in general. If an object is provided, check
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        permissions for that object.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Active superusers have all permissions.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>is_active <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>is_superuser:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Otherwise we need to check the backends.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> _user_has_perm(self, perm, obj)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>has_perms</span>(self, perm_list, obj<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        Return True if the user has each of the specified permissions. If
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        object is passed, check if the user has all required perms for it.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> all(self<span style=color:#f92672>.</span>has_perm(perm, obj) <span style=color:#66d9ef>for</span> perm <span style=color:#f92672>in</span> perm_list)
</span></span></code></pre></div><p>ç„¶åè¦è€ƒè™‘çš„å°±æ˜¯å¦‚ä½•å°†æƒé™åˆ†ç»™ç”¨æˆ·äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Django æºç ä¸­çœ‹åˆ° user å’Œ permission çš„å…³è”å…³ç³»æ˜¯ï¼šManyToMany ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹ç”¨æˆ·çš„<code>user_permissions</code>å­—æ®µå°±å¯ä»¥äº†ã€‚é’ˆå¯¹ group ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    In [<span style=color:#ae81ff>36</span>]: shawn <span style=color:#f92672>=</span> User<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(username<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;shawn&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>37</span>]: perm <span style=color:#f92672>=</span> Permission<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>get(codename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;add_user&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>38</span>]: shawn<span style=color:#f92672>.</span>user_permissions<span style=color:#f92672>.</span>add(perm)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>39</span>]: shawn<span style=color:#f92672>.</span>save()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    In [<span style=color:#ae81ff>40</span>]: shawn<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;auth.add_user&#39;</span>)
</span></span><span style=display:flex><span>    Out[<span style=color:#ae81ff>40</span>]: <span style=color:#66d9ef>True</span>
</span></span></code></pre></div><blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒå¹²æ‰°äººçš„é—®é¢˜ï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘çš„ codename æ˜æ˜æ˜¯ add_user ä½†æ˜¯æ ¡éªŒçš„æ—¶å€™å´è¦ç”¨<code>auth.add_user</code>ã€‚å½“æ˜¯è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å›°æ‰°äº†æˆ‘æ¯”è¾ƒä¹…ï¼Œè¿˜å› ä¸ºè¿™ä¸ªé—®é¢˜å¯¼è‡´äº†æˆ‘ç¨‹åºå‡ºç° bugï¼ˆæ¯”å¦‚æœ¬æ¥è¯¥æ ¡éªŒ<code>car.open_door</code>çš„åœ°æ–¹æˆ‘æ ¡éªŒäº†<code>open_door</code>ï¼‰ã€‚æ¯”è¾ƒæ˜æ˜¾çš„ä¸€å¤„æ˜¯å› ä¸ºâ€œé‡åâ€œï¼Œå› ä¸ºæˆ‘ä»¬ model å¤šäº†ä¹‹åä¼šå‡ºç°å¥½å¤šå¤„é‡åçš„æƒé™åï¼Œæ‰€ä»¥æ ¡éªŒçš„æ—¶å€™åº”è¯¥åœ¨codename å‰é¢åŠ ä¸Š app_nameã€‚å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘ä»¬ settings é‡Œé¢çš„ INSTALLED_APPS é…ç½®ï¼Œæœ‰ä¸€æ¡å°±æ˜¯<code>django.contrib.auth</code>ã€‚</p></blockquote><h1 id=0x02-drf-ä¸­çš„æƒé™è®¾è®¡>0X02 DRF ä¸­çš„æƒé™è®¾è®¡</h1><p>æˆ‘ä»¬åœ¨é…ç½® DRF çš„æ—¶å€™é€šå¸¸ä¼šåœ¨ settings é‡Œå†™ä¸‹ç±»ä¼¼è¿™æ ·çš„é…ç½®ï¼Œè¿™æ„å‘³ç€ç»™é»˜è®¤çš„ permission_class è®¾ç½®æˆäº†<code>IsAuthenticated</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç™»å½•å³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    REST_FRAMEWORK <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;DEFAULT_PERMISSION_CLASSES&#39;</span>: (
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;rest_framework.permissions.IsAuthenticated&#39;</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    	  <span style=color:#75715e>#..............</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>ä½†æ˜¯è¿™ä¹Ÿåªæ˜¯ä¸€ä¸ªé»˜è®¤çš„æƒé™é…ç½®ï¼Œä½ ç”¨ DRF çš„<code>ViewSet</code>åˆ›å»ºçš„æ–° API é»˜è®¤æ˜¯ç™»å½•å³å¯ï¼Œä½†æ˜¯æ€»ä¼šæœ‰å…¶ä»–çš„æƒ…å†µï¼Œè¿™ç§æ—¶å€™é€šå¸¸æ¥è¯´æˆ‘æˆ‘ä»¬ä¼šé‡å†™ ViewSet ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼š<code>get_permissions</code>å’Œ<code>get_queryset</code>ã€‚å…ˆè¯´æ­£ç»çš„æƒé™ï¼Œä¹Ÿå°±æ˜¯<code>get_permissions</code>å¥½äº†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>APIView</span>(View):
</span></span><span style=display:flex><span>        permission_classes <span style=color:#f92672>=</span> api_settings<span style=color:#f92672>.</span>DEFAULT_PERMISSION_CLASSES
</span></span><span style=display:flex><span>        <span style=color:#75715e># .........</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    		<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_permissions</span>(self):
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Instantiates and returns the list of permissions that this view requires.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> [permission() <span style=color:#66d9ef>for</span> permission <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>permission_classes]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_permissions</span>(self, request):
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Check if the request should be permitted.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Raises an appropriate exception if the request is not permitted.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> permission <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>get_permissions():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> permission<span style=color:#f92672>.</span>has_permission(request, self):
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>permission_denied(
</span></span><span style=display:flex><span>                        request, message<span style=color:#f92672>=</span>getattr(permission, <span style=color:#e6db74>&#39;message&#39;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>                    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_object_permissions</span>(self, request, obj):
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Check if the request should be permitted for a given object.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            Raises an appropriate exception if the request is not permitted.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> permission <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>get_permissions():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> permission<span style=color:#f92672>.</span>has_object_permission(request, self, obj):
</span></span><span style=display:flex><span>                    self<span style=color:#f92672>.</span>permission_denied(
</span></span><span style=display:flex><span>                        request, message<span style=color:#f92672>=</span>getattr(permission, <span style=color:#e6db74>&#39;message&#39;</span>, <span style=color:#66d9ef>None</span>)
</span></span><span style=display:flex><span>                    )
</span></span></code></pre></div><p>æˆ‘ä»¬ä»æºç ä¸­å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•å…¶å®å¾ˆå¾ˆç®€å•ï¼Œå°±åªæ˜¯æŠŠ<code>self.permission_classesä¸€éï¼Œé€šè¿‡ codename è¿›è¡Œå®ä¾‹åŒ–ï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå®ä¾‹åŒ–çš„ permission åˆ—è¡¨ã€‚ç„¶ååœ¨</code>check_permissions<code>æˆ–è€…</code>check_object_permissions<code>çš„æ—¶å€™å¯¹è¿™ä¸ªåˆ—è¡¨è½®è¯¢ä¸€éï¼Œè°ƒç”¨ permission å®ä¾‹çš„</code>has_object_permission(request, view)`æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦æœ‰æƒé™æ‰§è¡Œæœ¬æ¬¡è¯·æ±‚ï¼Œæœ€ç»ˆé€šè¿‡è¿”å›çš„ True/False æ¥ç¡®å®šæ˜¯å¦æœ‰æƒé™ç»§ç»­æ“ä½œï¼Œå¦‚æœæ²¡æœ‰æƒé™å°±ç›´æ¥ç»ˆæ­¢è¯·æ±‚äº†ã€‚</p><p>æ ¹æ®ä¸Šè¿°æ¡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæƒé™æ ¡éªŒç±»äº†ï¼Œä¸€ä¸ªç®€å•çš„å®ç°æ—¶ä¸‹é¢è¿™ç§æ ·å­çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#f92672>from</span> rest_framework <span style=color:#f92672>import</span> permissions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PermsRequired</span>(permissions<span style=color:#f92672>.</span>BasePermission):
</span></span><span style=display:flex><span>    		<span style=color:#e6db74>&#34;&#34;&#34;éœ€è¦æœ‰å¤šä¸ªæƒé™ä¹‹ä¸€ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰å…¶ä¸­ä¸€ä¸ªæƒé™å³å¯&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self, <span style=color:#f92672>*</span>perms):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>perms <span style=color:#f92672>=</span> perms	<span style=color:#75715e># æ¥å—å¤šä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯æƒé™</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__call__</span>(self):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self  <span style=color:#75715e># è¢« callï¼ˆå‰æœŸå¯ä»¥ç†è§£æˆè¢«å½“æˆå‡½æ•°è°ƒç”¨ï¼‰ çš„æ—¶å€™è¿”å›è‡ªèº«</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>has_permission</span>(self, request, view):
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>user		<span style=color:#75715e># æ—¢ç„¶ä¼ è¿›æ¥äº† requestï¼Œé‚£å°±å¯ä»¥æ‹¿åˆ° user äº†</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> user<span style=color:#f92672>.</span>is_superuser:	<span style=color:#75715e># superuser æ‹¥æœ‰ä¸€åˆ‡æƒé™</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            user_perms <span style=color:#f92672>=</span> user<span style=color:#f92672>.</span>get_all_permissions()	 <span style=color:#75715e># å–å¾—ç”¨æˆ·æ‰€æ‹¥æœ‰çš„çš„æ‰€æœ‰æƒé™</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># å–æœ¬æ¬¡éœ€è¦çš„æƒé™å’Œç”¨æˆ·æ‰€æœ‰çš„æƒé™çš„äº¤é›†ï¼Œå¦‚æœæœ‰äº¤é›†åˆ™æ ¡éªŒé€šè¿‡ï¼ˆä¹Ÿå°±æ˜¯ â€œæˆ–â€ æ ¡éªŒ</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span> <span style=color:#66d9ef>if</span> user_perms <span style=color:#f92672>&amp;</span> set(self<span style=color:#f92672>.</span>perms) <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          	<span style=color:#75715e># å¦‚æœæƒ³è¦â€œä¸â€æ ¡éªŒï¼Œå¯ä»¥æ”¹æˆä¸‹é¢è¿™ç§</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># return all([perm in user_perms for perm in set(self.perms)])</span>
</span></span></code></pre></div><h1 id=0x03-drf-å¦‚ä½•æ ¡éªŒæƒé™>0X03 DRF å¦‚ä½•æ ¡éªŒæƒé™</h1><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ Django å’Œ DRF ä¸­çš„æƒé™å¤§æ¦‚æ˜¯æ€ä¹ˆå®ç°çš„äº†ï¼Œé‚£ä¹ˆå…·ä½“æ€ä¹ˆç”¨åœ¨ DRF æ¡†æ¶çš„ web ç¨‹åºä¸­å‘¢ï¼Ÿä¸‹é¢çœ‹ä¸€æ®µå®ä¾‹ä»£ç ã€‚è¿™å¨ä»£ç å°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„ä¸€ä¸ª DRF å¼€å‡ºæ¥çš„ ViewSet äº†ï¼ŒåŒæ—¶æ”¯æŒ<code>GET/POST/PUT/PATCH/DELETE</code>äº”ç§ HTTP æ–¹æ³•ã€‚</p><blockquote><p>åœ¨ DRF çš„ ViewSet ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ self.action æ¥è®¿é—®åˆ°å½“å‰è¯·æ±‚çš„ functionã€‚é»˜è®¤æƒ…å†µä¸‹çš„ CRUD å¯¹åº”çš„æ–¹æ³•åæ˜¯ï¼š<code>list/create/retrieve/partial_update/update/delete</code>è¿™äº”ä¸ªï¼Œåˆ†åˆ«å¯¹åº”äº†<code>GET /</code>,<code>POST /</code>,<code>GET /id/</code>,<code>PATCH /id/</code>,<code>PUT /id/</code>,<code>DELETE /id/</code></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StudentViewSet</span>(viewsets<span style=color:#f92672>.</span>ModelViewSet):
</span></span><span style=display:flex><span>      	queryset <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>Student<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>all()
</span></span><span style=display:flex><span>      	<span style=color:#75715e># ...........</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_permissions</span>(self):
</span></span><span style=display:flex><span>          	<span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>action <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;list&#39;</span>:		<span style=color:#75715e># å¦‚æœæ˜¯å¯¹æ ¹ç›®å½•è¿›è¡Œ GET åˆ™éœ€è¦åˆ—è¡¨æƒé™</span>
</span></span><span style=display:flex><span>     						self<span style=color:#f92672>.</span>permission_classes <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>                    perms<span style=color:#f92672>.</span>PermsRequired(<span style=color:#e6db74>&#39;student.list_student&#39;</span>),
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>action <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;create&#39;</span>:		<span style=color:#75715e># å¦‚æœå¯¹æ ¹ç›®å½•è¿›è¡Œ POST åˆ™éœ€è¦åˆ›å»ºæƒé™</span>
</span></span><span style=display:flex><span>                self<span style=color:#f92672>.</span>permission_classes <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>                    perms<span style=color:#f92672>.</span>PermsRequired(<span style=color:#e6db74>&#39;student.create_student&#39;</span>),
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> super(StudentViewSet, self)<span style=color:#f92672>.</span>get_permissions()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_serializer_class</span>(self):
</span></span><span style=display:flex><span>          	<span style=color:#75715e># ........</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>serializer_class
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_queryset</span>(self):
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>request<span style=color:#f92672>.</span>user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># å¦‚æœç”¨æˆ·æ‹¥æœ‰æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯çš„æƒé™ï¼Œåˆ™è¿”å›æ‰€æœ‰å­¦ç”Ÿä¿¡æ¯</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> user<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;student.query_all_students&#39;</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>queryset
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># å¦‚æœç”¨æˆ·æœ‰æŸ¥çœ‹è‡ªå·±ç­é‡Œå­¦ç”Ÿä¿¡æ¯çš„æƒé™ï¼Œåˆ™è¿”å›è‡ªå·±ç­é‡Œçš„å­¦ç”Ÿä¿¡æ¯</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> user<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;ratel.query_self_class_students&#39;</span>):
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>queryset<span style=color:#f92672>.</span>filter(
</span></span><span style=display:flex><span>                    student_class<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>student<span style=color:#f92672>.</span>student_class
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>            <span style=color:#75715e># ...è¿˜æœ‰å…¶ä»–æ ¡éªŒ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># å¦‚æœä»€ä¹ˆæƒé™éƒ½æ²¡æ‰¾åˆ°ï¼Œé‚£å°±åªèƒ½è¿”å›è‡ªå·±çš„æ•°æ®äº†</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> models<span style=color:#f92672>.</span>Student<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter(id<span style=color:#f92672>=</span>user<span style=color:#f92672>.</span>student<span style=color:#f92672>.</span>id)
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥ä»ä¸Šé¢çœ‹åˆ°æœ‰ä¸¤ä¸ªåœ°æ–¹åœ¨æ ¡éªŒæƒé™ï¼Œä¸€ä¸ªæ˜¯<code>get_permissions()</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>get_queryset()</code>ã€‚å‰è€…æ˜¯ä¸¥è°¨çš„â€œæƒé™â€ï¼Œä¹Ÿå°±æ˜¯è¯´â€œä½ æƒ³è¦æ‰§è¡ŒæŸæŸæŸæ“ä½œï¼Œä½ å°±éœ€è¦æ‹¥æœ‰æŸæŸæŸæƒé™ï¼Œæ²¡æœ‰å°±ä¸ä¿¡â€ï¼›åè€…æ˜¯å¹¿ä¹‰çš„â€œæƒé™â€ï¼Œä¼šä»å¤§åˆ°å°æ¥æ ¡éªŒï¼Œæ¯”å¦‚è¿™é‡Œå¯ä»¥å…ˆåˆ¤æ–­ä½ æ˜¯å¦æ‹¥æœ‰æŸ¥çœ‹æ‰€æœ‰äººä¿¡æ¯çš„æƒé™ï¼Œæœ‰ï¼Œå°±ç»™ä½ æ‰€æœ‰äººçš„ä¿¡æ¯ï¼›æ²¡æœ‰ï¼Œå°±çœ‹ä½ èƒ½ä¸èƒ½çœ‹ç­é‡Œäººçš„ä¿¡æ¯ï¼Œæœ‰ï¼Œå°±ç»™ä½ ç­é‡Œäººçš„ä¿¡æ¯ï¼›æ²¡æœ‰ï¼Œå°±åªè¿”å›ç»™ä½ è‡ªå·±çš„æ•°æ®ã€‚</p><p>è¿™ä¸¤ç§ç”¨æ³•æ˜¯åœ¨æ—¥å¸¸å·¥ä½œä¸­ç”¨æ³•æœ€å¤šçš„äº†ã€‚å…¶ä»–å†æœ‰çš„è¯å°±æ˜¯åœ¨ serializer çš„ validate ä¸­è¿›è¡Œçš„æ ¡éªŒï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªåŠŸèƒ½å«åšâ€œå¼ºåˆ¶åˆ é™¤â€ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥è·³è¿‡ä¸€åˆ‡æ£€æµ‹ï¼ˆæ¯”å¦‚æ£€æµ‹å­¦ç”Ÿæ˜¯å¦åœ¨æ ¡ï¼Œå­¦ç”Ÿæ˜¯å¦æ¯•ä¸šè¶…è¿‡3 å¹´ï¼Œå­¦ç”Ÿé¥­å¡æ˜¯å¦è¿˜æœ‰é’±ï¼‰ï¼Œå°±ç›´æ¥åˆ é™¤ã€‚è¿™ç§æƒé™å¯èƒ½åªä¼šåˆ†é…ç»™é«˜çº§åˆ«ç®¡ç†å‘˜ä½¿ç”¨ï¼Œä½†æ˜¯åˆä¸å¯èƒ½é’ˆå¯¹è¿™ç§åŠŸèƒ½å†å•ç‹¬å¼€æ–°çš„ API æ¥åšï¼Œè¿™æ ·å¤ªå¥‡æ€ªäº†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªå‚æ•°æ¥æ§åˆ¶å‰ç½®åˆ é™¤ï¼Œæ¯”å¦‚<code>force_delete</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å†™å‡ºç±»ä¼¼ä¸‹é¢çš„ä»£ç </p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>validate</span>(self, validated_data):
</span></span><span style=display:flex><span>      	user <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>context[<span style=color:#e6db74>&#39;request&#39;</span>]<span style=color:#f92672>.</span>user
</span></span><span style=display:flex><span>        force_delete <span style=color:#f92672>=</span> validated_data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;force_delete&#39;</span>, <span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> force_delete:
</span></span><span style=display:flex><span>          	<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> user<span style=color:#f92672>.</span>has_perm(<span style=color:#e6db74>&#39;student.force_delete&#39;</span>):
</span></span><span style=display:flex><span>            		<span style=color:#66d9ef>raise</span> serializers<span style=color:#f92672>.</span>ValidationError(<span style=color:#e6db74>&#39;ä½ æ²¡æœ‰å¼ºåˆ¶åˆ é™¤ç”¨æˆ·çš„æƒé™&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      	<span style=color:#66d9ef>return</span> validated_data
</span></span></code></pre></div><h1 id=0x04-the-end>0X04 THE END</h1><p>ä»Šå¤©æ˜¯ä¸ªç¾å¥½çš„å‘¨æ—¥ï¼Œä¸­åˆçš„æ—¶å€™æƒ³è¦å–äº†å’–å•¡å†™ç¯‡åšå®¢å°±å»ç© <em>ç«ç„°çº¹ç« </em> çš„çš„ï¼Œç„¶è€Œè¶Šçœ‹è¿™ä¸ªæƒé™è¶Šè¶Šè§‰å¾—è‡ªå·±ä¸æ‡‚ï¼Œä¹‹å‰ä¸€åº¦ä»¥ä¸ºè‡ªå·±æŒºæ˜ç™½çš„ï¼Œç»“æœä¸€ç›´æ˜¯å¤„åœ¨çŸ¥å…¶ç„¶çš„çŠ¶æ€ï¼Œå¹¶æ²¡æœ‰çŸ¥å…¶æ‰€ä»¥ç„¶ï¼ˆè™½ç„¶ç°åœ¨çŸ¥é“ä¹Ÿä¹Ÿä¸å½»åº•ï¼‰ã€‚ç„¶åå°±ä¸€ç‚¹ç‚¹çœ‹ä¹‹å‰çš„ä»£ç ï¼Œçœ‹å®ç°æ–¹æ¡ˆï¼Œçœ‹ç€çœ‹ç€åˆå¾—è¿›å»çœ‹æºç ï¼Œç»“æœè®¡åˆ’ä¸€ä¸ªå¤šå°æ—¶æå®šçš„ä¸œè¥¿æäº†å¿«å››ä¸ªå°æ—¶ã€‚ä¸è¿‡è¿˜å¥½ï¼Œä¹Ÿä¸äºï¼Œæ”¶è·é¢‡ä¸°~</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2025-01-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/django/>Django</a>,&nbsp;<a href=/tags/drf/>DRF</a>,&nbsp;<a href=/tags/permission/>Permission</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/posts/sso-yu-cas/ class=prev rel=prev title="SSO ä¸ CAS"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>SSO ä¸ CAS</a>
<a href=/posts/django-save-exception/ class=next rel=next title="è®°ä¸€æ¬¡ Django save å¯¼è‡´çš„æ•°æ®å¼‚å¸¸">è®°ä¸€æ¬¡ Django save å¯¼è‡´çš„æ•°æ®å¼‚å¸¸<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2015 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.programmer.work target=_blank>Shawn</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/gitalk/gitalk.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/gitalk/gitalk.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:50},comment:{gitalk:{admin:["shawn-bluce"],clientID:"Ov23ligzD7mU8WBsue6H",clientSecret:"a832d1ba967e3a40f5485aa05e2a9e76f2d77901",id:"2020-07-05T05:24:00Z",owner:"shawn-bluce",repo:"shawn-bluce.github.io",title:"å¦‚ä½•åœ¨ Django ä¸ DRF ä¸­ä¼˜é›…åœ°æ ¡éªŒæƒé™"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>