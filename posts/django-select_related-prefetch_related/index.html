<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>使用 Django 中的 select_related 和 prefetch_related 优化查询 - Shawn's blog</title><meta name=Description content="分享我的知识、经验、生活与感悟"><meta property="og:url" content="https://blog.programmer.work/posts/django-select_related-prefetch_related/"><meta property="og:site_name" content="Shawn's blog"><meta property="og:title" content="使用 Django 中的 select_related 和 prefetch_related 优化查询"><meta property="og:description" content="0X00 前言 没有什么前言，只有一个数据库模型，下面的代码使用这个模型拿来测试。
from django.db import models class Major(models.Model): name = models.CharField( '名字', max_length=100, blank=True, null=True, ) class Student(models.Model): name = models.CharField( '名字', max_length=100, blank=True, null=True, ) select_major = models.ForeignKey( Major, verbose_name='专业', on_delete=models.SET_NULL, blank=True, null=True, related_name='main_student', ) ext_major = models.ManyToManyField( Major, verbose_name='附加专业', related_name='ext_student', ) 我们先假设Major表存在10条数据，而Student表存在1万条数据。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-12T13:59:00+00:00"><meta property="article:modified_time" content="2025-01-16T07:42:08+00:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Django"><meta property="article:tag" content="ORM"><meta property="og:image" content="https://blog.programmer.work/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.programmer.work/logo.png"><meta name=twitter:title content="使用 Django 中的 select_related 和 prefetch_related 优化查询"><meta name=twitter:description content="0X00 前言 没有什么前言，只有一个数据库模型，下面的代码使用这个模型拿来测试。
from django.db import models class Major(models.Model): name = models.CharField( '名字', max_length=100, blank=True, null=True, ) class Student(models.Model): name = models.CharField( '名字', max_length=100, blank=True, null=True, ) select_major = models.ForeignKey( Major, verbose_name='专业', on_delete=models.SET_NULL, blank=True, null=True, related_name='main_student', ) ext_major = models.ManyToManyField( Major, verbose_name='附加专业', related_name='ext_student', ) 我们先假设Major表存在10条数据，而Student表存在1万条数据。"><meta name=application-name content="Shawn's blog"><meta name=apple-mobile-web-app-title content="Shawn's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.programmer.work/posts/django-select_related-prefetch_related/><link rel=prev href=https://blog.programmer.work/posts/why-https-is-security/><link rel=next href=https://blog.programmer.work/posts/python-iterator-and-generators/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"使用 Django 中的 select_related 和 prefetch_related 优化查询","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.programmer.work\/posts\/django-select_related-prefetch_related\/"},"genre":"posts","keywords":"Python, Django, ORM","wordcount":1803,"url":"https:\/\/blog.programmer.work\/posts\/django-select_related-prefetch_related\/","datePublished":"2019-05-12T13:59:00+00:00","dateModified":"2025-01-16T07:42:08+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Shawn"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Shawn's blog">Shawn's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Shawn's blog">Shawn's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用 Django 中的 select_related 和 prefetch_related 优化查询</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.programmer.work title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Shawn</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-05-12>2019-05-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1803 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><h1 id=0x00-前言>0X00 前言</h1><p>没有什么前言，只有一个数据库模型，下面的代码使用这个模型拿来测试。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#f92672>from</span> django.db <span style=color:#f92672>import</span> models
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Major</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;名字&#39;</span>,
</span></span><span style=display:flex><span>            max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>            blank<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Student</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;名字&#39;</span>,
</span></span><span style=display:flex><span>            max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>            blank<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        select_major <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(
</span></span><span style=display:flex><span>            Major,
</span></span><span style=display:flex><span>            verbose_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;专业&#39;</span>,
</span></span><span style=display:flex><span>            on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>SET_NULL,
</span></span><span style=display:flex><span>            blank<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>            related_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;main_student&#39;</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        ext_major <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ManyToManyField(
</span></span><span style=display:flex><span>            Major,
</span></span><span style=display:flex><span>            verbose_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;附加专业&#39;</span>,
</span></span><span style=display:flex><span>            related_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;ext_student&#39;</span>,
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><p>我们先假设Major表存在10条数据，而Student表存在1万条数据。</p><h1 id=0x01-使用select_related>0X01 使用select_related</h1><p>如果我们要得到所有的学生和他们所学专业的名字，那么我们可以轻松写出下面的代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>for</span> student <span style=color:#f92672>in</span> Student<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>all():
</span></span><span style=display:flex><span>        print(student<span style=color:#f92672>.</span>name, <span style=color:#e6db74>&#39;--&gt;&#39;</span>, student<span style=color:#f92672>.</span>selected_major<span style=color:#f92672>.</span>name)
</span></span></code></pre></div><p>这样就能得到所有学生姓名和他们所学的专业名了，但是重点在于这次查询其实是一个很低效的查询，因为在<code>Student.objects.all()</code>的时候查询了一次数据库，而且每次访问<code>student.selected_major.name</code>的时候都会再查询一次数据库，基于上述条件这两行代码将会查询10001次数据库，是一个比较夸张的数字了。那么如何用<code>select_related</code>来优化这次查询呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>for</span> student <span style=color:#f92672>in</span> Student<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>all()<span style=color:#f92672>.</span>select_related(<span style=color:#e6db74>&#39;major&#39;</span>):
</span></span><span style=display:flex><span>        print(student<span style=color:#f92672>.</span>name, <span style=color:#e6db74>&#39;--&gt;&#39;</span>, student<span style=color:#f92672>.</span>selected_major<span style=color:#f92672>.</span>name)
</span></span></code></pre></div><p>其实就是在<code>all()</code>之后添加了<code>select_related('major')</code>，这次就只需要对数据库进行一次查询。在我本地的类似环境下测试结果是不使用<code>select_related</code>消耗的时间是优化后的400%左右。</p><blockquote><p>本质上是<code>select_related</code>进行了数据库级的JOIN操作，具体的大家可以通过查看<code>print(Model.objects.filter().query)</code>或者<code>django-extensions</code>等方法查看具体的SQL</p></blockquote><p>这里可能会有一种声音“查询从10001次到1次差了几乎10000倍时间却只省下了70%多？”这个问题其实比较好理解，JOIN操作本来就会使一次SQL查询变的很慢，毕竟要跨越多张表。</p><p><code>select_related</code>是用于优化“多对一”结构中从“多”表出发查“一”表，也就是这里的多个学生对一个专业，从学生出发查询得到“专业”。</p><p>这里我贴出使用前和使用后的两坨SQL，大家可以对比一下。（这些SQL都是Django-extensions分析得出的）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>优化前</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_student&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_major&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_major&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>一直重复，直到循环结束</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>优化后</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_student&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>OUTER</span> <span style=color:#66d9ef>JOIN</span> <span style=color:#e6db74>&#34;School_major&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>ON</span> (<span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>只剩下了一条使用了</span>JOIN的SQL<span style=color:#960050;background-color:#1e0010>，显然会比上面快很多</span>
</span></span></code></pre></div><h1 id=0x02-使用prefetch_related>0X02 使用prefetch_related</h1><p><code>prefetch_related</code>是从“一对多”结构中“一”表出发查“多”表，也就是说从专业表出发查询得到学生信息。比如我们想看这所有专业中每个专业下的学生</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>for</span> major <span style=color:#f92672>in</span> Major<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter():
</span></span><span style=display:flex><span>        print(major<span style=color:#f92672>.</span>main_student<span style=color:#f92672>.</span>all())
</span></span></code></pre></div><p>这种查询是最容易写出来的，不过需要注意的一点是，这里第一行循环前有一个<code>filter()</code>会查询一次数据库，后面每一次<code>main_student.all()</code>都会再查询数据库。我们只有10个专业，查11次数据库还行问题不大，但是随着数据增多这里查询数据库的次数会呈线性增长。那么如何解决这个问题呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    <span style=color:#66d9ef>for</span> major <span style=color:#f92672>in</span> Major<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>filter()<span style=color:#f92672>.</span>prefetch_related(<span style=color:#e6db74>&#39;main_student&#39;</span>):
</span></span><span style=display:flex><span>        print(major<span style=color:#f92672>.</span>main_student<span style=color:#f92672>.</span>all())
</span></span></code></pre></div><p>就只是向上面使用<code>select_related</code>一样添加一个<code>prefetch_related</code>在<code>filter()</code>后面就可以了。修改了之后的代码只会查询两次数据库：第一次把所有的专业查出来了，也就是<code>Major.objects.filter()</code>的作用；第二次是使用一个<code>SELECT * FROM student WHERE select_major_id IN (x,x,x,x,x,x)</code>形式的SQL查询到了对应的Student。<strong>然后使用Python将其组装整合而非数据库</strong> ，这样就能大幅度减少查询数据库的次数了。</p><p>这里我贴出使用前和使用后的两坨SQL，大家可以对比一下。（这些SQL都是Django-extensions分析得出的）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>优化前</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_major&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_student&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_student&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>    ......<span style=color:#960050;background-color:#1e0010>一直重复直到循环完所有的</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>优化后</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_major&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_major&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>           <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#34;School_student&#34;</span>
</span></span><span style=display:flex><span>     <span style=color:#66d9ef>WHERE</span> <span style=color:#e6db74>&#34;School_student&#34;</span>.<span style=color:#e6db74>&#34;select_major_id&#34;</span> <span style=color:#66d9ef>IN</span> (<span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>21</span>, <span style=color:#ae81ff>22</span>, <span style=color:#ae81ff>23</span>, <span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>26</span>, <span style=color:#ae81ff>27</span>, <span style=color:#ae81ff>28</span>, <span style=color:#ae81ff>29</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>31</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>33</span>, <span style=color:#ae81ff>34</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>37</span>, <span style=color:#ae81ff>38</span>, <span style=color:#ae81ff>39</span>, <span style=color:#ae81ff>40</span>, <span style=color:#ae81ff>41</span>, <span style=color:#ae81ff>42</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>44</span>, <span style=color:#ae81ff>45</span>, <span style=color:#ae81ff>46</span>, <span style=color:#ae81ff>47</span>, <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>51</span>, <span style=color:#ae81ff>52</span>, <span style=color:#ae81ff>53</span>, <span style=color:#ae81ff>54</span>, <span style=color:#ae81ff>55</span>, <span style=color:#ae81ff>56</span>, <span style=color:#ae81ff>57</span>, <span style=color:#ae81ff>58</span>, <span style=color:#ae81ff>59</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>61</span>, <span style=color:#ae81ff>62</span>, <span style=color:#ae81ff>63</span>, <span style=color:#ae81ff>64</span>, <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>66</span>, <span style=color:#ae81ff>67</span>, <span style=color:#ae81ff>68</span>, <span style=color:#ae81ff>69</span>, <span style=color:#ae81ff>70</span>, <span style=color:#ae81ff>71</span>, <span style=color:#ae81ff>72</span>, <span style=color:#ae81ff>73</span>, <span style=color:#ae81ff>74</span>, <span style=color:#ae81ff>75</span>, <span style=color:#ae81ff>76</span>, <span style=color:#ae81ff>77</span>, <span style=color:#ae81ff>78</span>, <span style=color:#ae81ff>79</span>, <span style=color:#ae81ff>80</span>, <span style=color:#ae81ff>81</span>, <span style=color:#ae81ff>82</span>, <span style=color:#ae81ff>83</span>, <span style=color:#ae81ff>84</span>, <span style=color:#ae81ff>85</span>, <span style=color:#ae81ff>86</span>, <span style=color:#ae81ff>87</span>, <span style=color:#ae81ff>88</span>, <span style=color:#ae81ff>89</span>, <span style=color:#ae81ff>90</span>, <span style=color:#ae81ff>91</span>, <span style=color:#ae81ff>92</span>, <span style=color:#ae81ff>93</span>, <span style=color:#ae81ff>94</span>, <span style=color:#ae81ff>95</span>, <span style=color:#ae81ff>96</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>99</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>102</span>, <span style=color:#ae81ff>103</span>)
</span></span></code></pre></div><h1 id=0x03-总结>0X03 总结</h1><p>还有总结？大家都有，我也有好了</p><p>通常来说恰当的使用<code>select_related</code>和<code>prefetch_related</code>可以大幅度提升自己ORM查询的速度，很多时候大家只是写了能用的查询，现在可以尝试着使用<code>select_related/prefetch_related</code>写出好用的查询啦</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-01-16</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/python/>Python</a>,&nbsp;<a href=/tags/django/>Django</a>,&nbsp;<a href=/tags/orm/>ORM</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/why-https-is-security/ class=prev rel=prev title=为什么https是安全的（简单介绍）><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>为什么https是安全的（简单介绍）</a>
<a href=/posts/python-iterator-and-generators/ class=next rel=next title="Python 中的可迭代对象、迭代器与生成器">Python 中的可迭代对象、迭代器与生成器<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=gitalk class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://github.com/gitalk/gitalk></a>Gitalk</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.152.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2015 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.programmer.work target=_blank>Shawn</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/gitalk/gitalk.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/gitalk/gitalk.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{gitalk:{admin:["shawn-bluce"],clientID:"Ov23ligzD7mU8WBsue6H",clientSecret:"a832d1ba967e3a40f5485aa05e2a9e76f2d77901",id:"2019-05-12T13:59:00Z",owner:"shawn-bluce",repo:"shawn-bluce.github.io",title:"使用 Django 中的 select_related 和 prefetch_related 优化查询"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>